# 生成对抗网络

## `待审核`1.问题：使用Fluid构建GAN时，报错

+ 问题描述：使用Fluid构建GAN时，报错

+ 报错输出：

```
-----------  Configuration Arguments -----------
batch_size: 121
epoch: 1
output: ./output
run_ce: False
use_gpu: 0
------------------------------------------------


Traceback (most recent call last):
  File "c_gan.py", line 204, in <module>
    train(args)
  File "c_gan.py", line 166, in train
    fetch_list={dg_loss})[0][0]
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/executor.py", line 470, in run
    self.executor.run(program.desc, scope, 0, True, True)
paddle.fluid.core.EnforceNotMet: DataType of Paddle Op sigmoid_cross_entropy_with_logits must be the same. Get fill_constant_batch_size_like_6.tmp_0(3) != fc_5.tmp_1(5) at [/Users/paddle/minqiyang/Paddle/paddle/fluid/framework/operator.cc:847]
PaddlePaddle Call Stacks:
0          0x11c0eca68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x11cf16a10p paddle::framework::OperatorWithKernel::IndicateDataType(paddle::framework::ExecutionContext const&) const + 864
2          0x11cf16aacp paddle::framework::OperatorWithKernel::GetExpectedKernelType(paddle::framework::ExecutionContext const&) const + 44
3          0x11cf15099p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 265
4          0x11cf11141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
5          0x11c1ba3a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
6          0x11c1b9dd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
7          0x11c120837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
8          0x11c0f73aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
9          0x10e4ad59fp PyCFunction_Call + 127
10         0x10e5787e7p PyEval_EvalFrameEx + 33207
11         0x10e56efafp _PyEval_EvalCodeWithName + 335
12         0x10e5752a7p PyEval_EvalFrameEx + 19575
13         0x10e574fb8p PyEval_EvalFrameEx + 18824
14         0x10e56efafp _PyEval_EvalCodeWithName + 335
15         0x10e5c1758p PyRun_FileExFlags + 248
16         0x10e5c0eeep PyRun_SimpleFileExFlags + 382
17         0x10e5e5d86p Py_Main + 3622
18         0x10e427861p main + 497
19      0x7fff763c5015p start + 1
```

+ 相关代码：

```python
with fluid.program_guard(dg_program):
    conditions = fluid.layers.data(
        name='conditions', shape=[1], dtype='float32')
    noise = fluid.layers.data(
        name='noise', shape=[NOISE_SIZE], dtype='float32')
    g_img = G_cond(z=noise, y=conditions)

    g_program = dg_program.clone()
    g_program_test = dg_program.clone(for_test=True)

    dg_logit = D_cond(g_img, conditions)
    dg_loss = loss(
        dg_logit,
        fluid.layers.fill_constant_batch_size_like(
                input=noise, dtype='int64', shape=[-1, 1], value=1.0))
```

+ 问题分析：

从报错输出中，发现`DataType of Paddle Op sigmoid_cross_entropy_with_logits must be the same`，该错误通常表明在定义sigmoid_cross_entropy_with_logits损失时，DataType(类型)不正确。

+ 解决方法：

```python
with fluid.program_guard(dg_program):
    conditions = fluid.layers.data(
        name='conditions', shape=[1], dtype='float32')
    noise = fluid.layers.data(
        name='noise', shape=[NOISE_SIZE], dtype='float32')
    g_img = G_cond(z=noise, y=conditions)

    g_program = dg_program.clone()
    g_program_test = dg_program.clone(for_test=True)

    dg_logit = D_cond(g_img, conditions)
    dg_loss = loss(
        dg_logit,
        fluid.layers.fill_constant_batch_size_like(
            input=noise, dtype='float32', shape=[-1, 1], value=1.0))
``` 


## `待审核`2.问题：使用的Fluid构建了GAN，训练了多轮后，发现输出的损失没有变化？


+ 问题描述：使用的Fluid构建了GAN，训练了多轮后，发现输出的损失没有变化？

+ 报错输出：


```
Epoch ID=20
 Batch ID=90
 D-Loss=1.5067135095596313
 DG-Loss=0.4147804379463196
 gen=[-0.1698921, -0.99956596, 0.9546677, -0.5599848, 0.19387577]
 Batch_time_cost=0.48
Epoch ID=20
 Batch ID=100
 D-Loss=1.5029923915863037
 DG-Loss=0.415465384721756
 gen=[-0.13936046, -0.99907386, 0.9638952, -0.5151914, 0.22195303]
 Batch_time_cost=0.49
Epoch ID=20
 Batch ID=110
 D-Loss=1.5026278495788574
 DG-Loss=0.41496896743774414
 gen=[-0.16337702, -0.9993104, 0.9370802, -0.55711323, 0.2029818]
 Batch_time_cost=0.49
Epoch ID=20
 Batch ID=120
 D-Loss=1.507551670074463
 DG-Loss=0.41562899947166443
 gen=[-0.17147928, -0.99922407, 0.96010137, -0.5696315, 0.19729234]
 Batch_time_cost=0.49
 ```

+ 相关代码：

```python
exe = fluid.Executor(fluid.CPUPlace())
if args.use_gpu:
    exe = fluid.Executor(fluid.CUDAPlace(0))
exe.run(fluid.default_startup_program())
if args.run_ce:
    train_reader = paddle.batch(
            paddle.dataset.mnist.train(),
            batch_size=args.batch_size)
else:
    train_reader = paddle.batch(
        paddle.reader.shuffle(
            paddle.dataset.mnist.train(), buf_size=60000),
        batch_size=args.batch_size)
```

+ 问题分析：

训练模式时，损失没有降低或没有变化，很有可能是优化器没有创建

+ 解决方法：

```
opt = fluid.optimizer.Adam(learning_rate=LEARNING_RATE)

opt.minimize(loss=d_loss)
parameters = [p.name for p in g_program.global_block().all_parameters()]

opt.minimize(loss=dg_loss, parameter_list=parameters)

exe = fluid.Executor(fluid.CPUPlace())
if args.use_gpu:
    exe = fluid.Executor(fluid.CUDAPlace(0))
exe.run(fluid.default_startup_program())
if args.run_ce:
    train_reader = paddle.batch(
            paddle.dataset.mnist.train(),
            batch_size=args.batch_size)
else:
    train_reader = paddle.batch(
        paddle.reader.shuffle(
            paddle.dataset.mnist.train(), buf_size=60000),
        batch_size=args.batch_size)
```


## `待审核`3.问题：Tensor not initialized yet when Tensor::type() is called

+ 问题描述：通过Fuild创建好GAN后，运行报错`Tensor not initialized yet when Tensor::type() is called`

+ 报错输出：

```
addle.fluid.core.EnforceNotMet: holder_ should not be null
Tensor not initialized yet when Tensor::type() is called. at [/Users/paddle/minqiyang/Paddle/paddle/fluid/framework/tensor.h:141]
PaddlePaddle Call Stacks:
0          0x11cf92a68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x11cf8fc12p paddle::framework::Tensor::type() const + 194
2          0x11d7687f1p paddle::operators::ReshapeOp::GetExpectedKernelType(paddle::framework::ExecutionContext const&) const + 81
3          0x11ddbb099p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 265
4          0x11ddb7141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
5          0x11d0603a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
6          0x11d05fdd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
7          0x11cfc6837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
8          0x11cf9d3aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
9          0x10f10259fp PyCFunction_Call + 127
10         0x10f1cd7e7p PyEval_EvalFrameEx + 33207
11         0x10f1c3fafp _PyEval_EvalCodeWithName + 335
12         0x10f1ca2a7p PyEval_EvalFrameEx + 19575
13         0x10f1c9fb8p PyEval_EvalFrameEx + 18824
14         0x10f1c3fafp _PyEval_EvalCodeWithName + 335
15         0x10f216758p PyRun_FileExFlags + 248
16         0x10f215eeep PyRun_SimpleFileExFlags + 382
17         0x10f23ad86p Py_Main + 3622
18         0x10f07c861p main + 497
19      0x7fff763c5015p start + 1
```

+ 相关代码：

```
if batch_id % 10 == 0 and not args.run_ce:
    if not os.path.exists(args.output):
        os.makedirs(args.output)

    generated_images = exe.run(
        g_program_test,
        fetch_list={g_img})[0]
    total_images = np.concatenate([real_image, generated_images])
    fig = plot(total_images)
    msg = "Epoch ID={0}\n Batch ID={1}\n D-Loss={2}\n DG-Loss={3}\n gen={4}\n " \
          "Batch_time_cost={5:.2f}".format(
        pass_id, batch_id, d_loss_n, dg_loss_n, check(generated_images), batch_time)
    print(msg)
    plt.title(msg)
    plt.savefig(
        '{}/{:04d}_{:04d}.png'.format(args.output, pass_id,
                                      batch_id),
        bbox_inches='tight')
    plt.close(fig)
```

+ 问题分析：

Tensor not initialized yet when Tensor::type() is called，表示张量在初始化时就失败了，检查训练时有没有将数据传入，只有正常传入了数据，才可避免这种错误。

+ 解决方法：

```python
if batch_id % 10 == 0 and not args.run_ce:
    if not os.path.exists(args.output):
        os.makedirs(args.output)

    generated_images = exe.run(
        g_program_test,
        feed={'noise': const_n,
              'conditions': conditions_data},
        fetch_list={g_img})[0]
    total_images = np.concatenate([real_image, generated_images])
    fig = plot(total_images)
    msg = "Epoch ID={0}\n Batch ID={1}\n D-Loss={2}\n DG-Loss={3}\n gen={4}\n " \
          "Batch_time_cost={5:.2f}".format(
        pass_id, batch_id, d_loss_n, dg_loss_n, check(generated_images), batch_time)
    print(msg)
    plt.title(msg)
    plt.savefig(
        '{}/{:04d}_{:04d}.png'.format(args.output, pass_id,
                                      batch_id),
        bbox_inches='tight')
    plt.close(fig)
```


## `待审核`4.问题：Fluid训练GAN时，损失变动异常

+ 问题描述：Fluid训练GAN时，损失常在1.1x左右浮动，不生不降，感觉比较异常

+ 报错输出：

```
Epoch ID=30
 Batch ID=140
 D-Loss=0.6971282362937927
 DG-Loss=0.6892679333686829
 gen=[-0.115929015, -0.9999876, 0.9999877, -0.77177113, 0.5410175]
 Batch_time_cost=1.13
Epoch ID=30
 Batch ID=150
 D-Loss=0.6962809562683105
 DG-Loss=0.6900284290313721
 gen=[-0.114548534, -0.9999947, 0.9999897, -0.77556163, 0.5226521]
 Batch_time_cost=1.12
Epoch ID=30
 Batch ID=160
 D-Loss=0.6965333819389343
 DG-Loss=0.6898457407951355
 gen=[-0.10191873, -0.9999936, 0.9999939, -0.7759285, 0.542791]
 Batch_time_cost=1.15
Epoch ID=30
 Batch ID=170
 D-Loss=0.6957794427871704
 DG-Loss=0.6905639171600342
 gen=[-0.10460779, -0.99999297, 0.9999937, -0.7692983, 0.528892]
 Batch_time_cost=1.14
Epoch ID=30
 Batch ID=180
 D-Loss=0.6958291530609131
 DG-Loss=0.6904556751251221
 gen=[-0.09769588, -0.99998635, 0.9999924, -0.7646928, 0.5333937]
 Batch_time_cost=1.13
 ```

+ 相关代码：

```
d_loss_n = exe.run(d_program,
feed={
   'img': generated_image,
   'label': fake_labels,
   'conditions': conditions_data
},
fetch_list={d_loss})[0][0]
```

+ 问题分析：

GAN有生成器与判别器两部分构成，通常，判别器的损失因由两部分组成，分别是判别器判断真实图像的损失以及判别器判断生成图像获得的损失

+ 解决方法：

```
d_loss_1 = exe.run(d_program,
                   feed={
                       'img': generated_image,
                       'label': fake_labels,
                       'conditions': conditions_data
                   },
                   fetch_list={d_loss})[0][0]

d_loss_2 = exe.run(d_program,
                   feed={
                       'img': real_image,
                       'label': real_labels,
                       'conditions': conditions_data
                   },
                   fetch_list={d_loss})[0][0]

d_loss_n = d_loss_1 + d_loss_2
```

## `待审核`5.问题：使用Fluid实现GAN后，运行报错

+ 问题描述：使用Fluid实现GAN后，运行报错

+ 报错输出：

```
paddle.fluid.core.EnforceNotMet: DataType of Paddle Op concat must be the same. Get noise(3) != conditions(5) at [/Users/paddle/minqiyang/Paddle/paddle/fluid/framework/operator.cc:847]
PaddlePaddle Call Stacks:
0          0x1190cea68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x119ef8a10p paddle::framework::OperatorWithKernel::IndicateDataType(paddle::framework::ExecutionContext const&) const + 864
2          0x119ef8aacp paddle::framework::OperatorWithKernel::GetExpectedKernelType(paddle::framework::ExecutionContext const&) const + 44
3          0x119ef7099p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 265
4          0x119ef3141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
5          0x11919c3a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
6          0x11919bdd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
7          0x119102837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
8          0x1190d93aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
9          0x10b84e59fp PyCFunction_Call + 127
10         0x10b9197e7p PyEval_EvalFrameEx + 33207
11         0x10b90ffafp _PyEval_EvalCodeWithName + 335
12         0x10b9162a7p PyEval_EvalFrameEx + 19575
13         0x10b915fb8p PyEval_EvalFrameEx + 18824
14         0x10b90ffafp _PyEval_EvalCodeWithName + 335
15         0x10b962758p PyRun_FileExFlags + 248
16         0x10b961eeep PyRun_SimpleFileExFlags + 382
17         0x10b986d86p Py_Main + 3622
18         0x10b7c8861p main + 497
19      0x7fff763c5015p start + 1
```

+ 相关代码：

```python
losses[0].append(d_loss_n)
for _ in six.moves.xrange(NUM_TRAIN_TIMES_OF_DG):
    noise_data = np.random.uniform(
        low=-1.0, high=1.0,
        size=[args.batch_size, NOISE_SIZE]).astype('int64')
    dg_loss_n = exe.run(
        dg_program,
        feed={'noise': noise_data,
              'conditions': conditions_data},
        fetch_list={dg_loss})[0][0]
    losses[1].append(dg_loss_n)
batch_time = time.time() - s_time
t_time += batch_time
```            

+ 问题分析：

报错输出中，存在`DataType of Paddle Op concat must be the same.`，说明操作节点中，存在数据类型不匹配的错误

+ 解决方法：

```python
losses[0].append(d_loss_n)
for _ in six.moves.xrange(NUM_TRAIN_TIMES_OF_DG):
    noise_data = np.random.uniform(
        low=-1.0, high=1.0,
        size=[args.batch_size, NOISE_SIZE]).astype('float32')
    dg_loss_n = exe.run(
        dg_program,
        feed={'noise': noise_data,
              'conditions': conditions_data},
        fetch_list={dg_loss})[0][0]
    losses[1].append(dg_loss_n)
batch_time = time.time() - s_time
t_time += batch_time
```


## `待审核`6.问题：DataType of Paddle Op mul must be the same.

+ 问题描述：通过Fuild实现GAN后，运行报DataType of Paddle Op mul must be the same.

+ 报错输出：

```
paddle.fluid.core.EnforceNotMet: DataType of Paddle Op mul must be the same. Get concat_4.tmp_0(6) != G_cond.fc.122.w(5) at [/Users/paddle/minqiyang/Paddle/paddle/fluid/framework/operator.cc:847]
PaddlePaddle Call Stacks:
0          0x10ea97a68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x10f8c1a10p paddle::framework::OperatorWithKernel::IndicateDataType(paddle::framework::ExecutionContext const&) const + 864
2          0x10f8c1aacp paddle::framework::OperatorWithKernel::GetExpectedKernelType(paddle::framework::ExecutionContext const&) const + 44
3          0x10f8c0099p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 265
4          0x10f8bc141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
5          0x10eb653a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
6          0x10eb64dd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
7          0x10eacb837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
8          0x10eaa23aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
9          0x101b3959fp PyCFunction_Call + 127
10         0x101c047e7p PyEval_EvalFrameEx + 33207
11         0x101bfafafp _PyEval_EvalCodeWithName + 335
12         0x101c012a7p PyEval_EvalFrameEx + 19575
13         0x101c00fb8p PyEval_EvalFrameEx + 18824
14         0x101bfafafp _PyEval_EvalCodeWithName + 335
15         0x101c4d758p PyRun_FileExFlags + 248
16         0x101c4ceeep PyRun_SimpleFileExFlags + 382
17         0x101c71d86p Py_Main + 3622
18         0x101ab3861p main + 497
19      0x7fff763c5015p start + 1
```

+ 相关代码：

```
noise_data = np.random.uniform(
low=-1.0, high=1.0,
size=[args.batch_size, NOISE_SIZE]).astype('float64')
real_image = np.array(list(map(lambda x: x[0], data))).reshape(
-1, 784).astype('float64')
conditions_data = np.array([x[1] for x in data]).reshape(
[-1, 1]).astype("float64")
real_labels = np.ones(
shape=[real_image.shape[0], 1], dtype='float64')
fake_labels = np.zeros(
shape=[real_image.shape[0], 1], dtype='float64')
```

+ 问题分析：

DataType of Paddle Op mul must be the same.表示是操作节点数据类型错误，与上一个错误是类似的，需要注意的时，读入的数据类似于操作节点操作时的数据类型要匹配。

+ 解决方法：

观察操作代码中使用了的数据类型，将读取数据时的数据类型定义为与之匹配的数据类型

```
noise_data = np.random.uniform(
                low=-1.0, high=1.0,
                size=[args.batch_size, NOISE_SIZE]).astype('float32')
real_image = np.array(list(map(lambda x: x[0], data))).reshape(
    -1, 784).astype('float32')
conditions_data = np.array([x[1] for x in data]).reshape(
    [-1, 1]).astype("float32")
real_labels = np.ones(
    shape=[real_image.shape[0], 1], dtype='float32')
fake_labels = np.zeros(
    shape=[real_image.shape[0], 1], dtype='float32')
```



## `待审核`7.问题： 通过Fuild使用cycleGAN后，运行报错

+ 问题描述：通过Fuild使用cycleGAN后，运行报错

+ 报错输出：

```
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 56, in train
    g_A_trainer = GATrainer(input_A, input_B)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/trainer.py", line 15, in __init__
    self.fake_B = build_generator_resnet_9blocks(input_A, name="g_A")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/model.py", line 18, in build_generator_resnet_9blocks
    o_c2 = conv2d(o_c1, 64, 3, 2, 0.02, "SAME", name + "_c2")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/layers.py", line 96, in conv2d
    offsets=(0, 0, 1, 1))
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/layers/nn.py", line 6102, in crop
    attrs=None if len(attrs) == 0 else attrs)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/layer_helper.py", line 50, in append_op
    return self.main_program.current_block().append_op(*args, **kwargs)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/framework.py", line 1207, in append_op
    op = Operator(block=self, desc=op_desc, *args, **kwargs)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/framework.py", line 656, in __init__
    self.desc.infer_shape(self.block.desc)
paddle.fluid.core.EnforceNotMet: Enforce failed. Expected int64_t(shape.size()) == x_dim.size(), but received int64_t(shape.size()):3 != x_dim.size():4.
Shape size should be equal to dimention size of input tensor. at [/Users/paddle/minqiyang/Paddle/paddle/fluid/operators/crop_op.cc:37]
PaddlePaddle Call Stacks:
0          0x11ca3da68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x11ccaa9d5p paddle::operators::CropOp::InferShape(paddle::framework::InferShapeContext*) const + 2501
2          0x11cafae68p paddle::framework::OpDesc::InferShape(paddle::framework::BlockDesc const&) const + 1496
3          0x11cac4479p _ZZN8pybind1112cpp_function10initializeIZNS0_C1IvN6paddle9framework6OpDescEJRKNS4_9BlockDescEEJNS_4nameENS_9is_methodENS_7siblingEEEEMT0_KFT_DpT1_EDpRKT2_EUlPKS5_S8_E_vJSN_S8_EJS9_SA_SB_EEEvOSD_PFSC_SF_ESL_ENKUlRNS_6detail13function_callEE_clESU_ + 185
4          0x11ca483aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
5          0x10f50059fp PyCFunction_Call + 127
6          0x10f5cb7e7p PyEval_EvalFrameEx + 33207
7          0x10f5c1fafp _PyEval_EvalCodeWithName + 335
8          0x10f4cd6aap function_call + 106
9          0x10f489b35p PyObject_Call + 69
10         0x10f4ac694p method_call + 148
11         0x10f489b35p PyObject_Call + 69
12         0x10f526415p slot_tp_init + 117
13         0x10f52aac1p type_call + 209
14         0x10f489b35p PyObject_Call + 69
15         0x10f5c8c9bp PyEval_EvalFrameEx + 22123
16         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
17         0x10f4cd6aap function_call + 106
18         0x10f489b35p PyObject_Call + 69
19         0x10f5c8c9bp PyEval_EvalFrameEx + 22123
20         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
21         0x10f5c82a7p PyEval_EvalFrameEx + 19575
22         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
23         0x10f5c82a7p PyEval_EvalFrameEx + 19575
24         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
25         0x10f5c82a7p PyEval_EvalFrameEx + 19575
26         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
27         0x10f5c82a7p PyEval_EvalFrameEx + 19575
28         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
29         0x10f4cd6aap function_call + 106
30         0x10f489b35p PyObject_Call + 69
31         0x10f4ac694p method_call + 148
32         0x10f489b35p PyObject_Call + 69
33         0x10f526415p slot_tp_init + 117
34         0x10f52aac1p type_call + 209
35         0x10f489b35p PyObject_Call + 69
36         0x10f5c816bp PyEval_EvalFrameEx + 19259
37         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
38         0x10f5c82a7p PyEval_EvalFrameEx + 19575
39         0x10f5c1fafp _PyEval_EvalCodeWithName + 335
40         0x10f614758p PyRun_FileExFlags + 248
41         0x10f613eeep PyRun_SimpleFileExFlags + 382
42         0x10f638d86p Py_Main + 3622
43         0x10f47a861p main + 497
44      0x7fff763c5015p start + 1
```

+ 相关代码：

```
conv = fluid.layers.conv2d(
        input,
        num_filters,
        filter_size,
        name=name,
        stride=stride,
        padding=padding,
        use_cudnn=use_cudnn,
        param_attr=param_attr,
        bias_attr=bias_attr)
if need_crop:
    conv = fluid.layers.crop(
        conv,
        shape=(conv.shape[1], conv.shape[2] - 1, conv.shape[3] - 1),
        offsets=(0, 0, 1, 1))
if norm:
    conv = instance_norm(input=conv, name=name + "_norm")
``` 

+ 问题分析：

Enforce failed.强制执行失败，通常是Paddle Fluid版中的某些方法使用错误导致的，通过报错输出的错误栈定位错误位置。进行修改则可。

+ 解决方法：

```
conv = fluid.layers.conv2d(
        input,
        num_filters,
        filter_size,
        name=name,
        stride=stride,
        padding=padding,
        use_cudnn=use_cudnn,
        param_attr=param_attr,
        bias_attr=bias_attr)
if need_crop:
    conv = fluid.layers.crop(
        conv,
        shape=(-1, conv.shape[1], conv.shape[2] - 1, conv.shape[3] - 1),
        offsets=(0, 0, 1, 1))
if norm:
    conv = instance_norm(input=conv, name=name + "_norm")
```


## `待审核`8.问题：参考models中的GAN代码编写GAN，运行出现下面错误

+ 问题描述：参考models中的GAN代码编写GAN，运行出现下面错误

+ 报错输出：


```
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 164, in train
    "input_B": tensor_B})
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/executor.py", line 470, in run
    self.executor.run(program.desc, scope, 0, True, True)
paddle.fluid.core.EnforceNotMet: Enforce failed. Expected x_dims[i + axis] == y_dims[i], but received x_dims[i + axis]:256 != y_dims[i]:264.
Broadcast dimension mismatch. at [/Users/paddle/minqiyang/Paddle/paddle/fluid/operators/elementwise_op_function.h:63]
PaddlePaddle Call Stacks:
0          0x111d85a68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x11228c45cp paddle::operators::get_mid_dims(paddle::framework::DDim const&, paddle::framework::DDim const&, int, int*, int*, int*) + 540
2          0x1123773bep void paddle::operators::ElementwiseComputeEx<paddle::operators::SubFunctor<float>, paddle::platform::CPUDeviceContext, float, float>(paddle::framework::ExecutionContext const&, paddle::framework::Tensor const*, paddle::framework::Tensor const*, int, paddle::operators::SubFunctor<float>, paddle::framework::Tensor*) + 1598
3          0x11262de07p paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, float>::Compute(paddle::framework::ExecutionContext const&) const + 359
4          0x11262dc60p std::__1::__function::__func<paddle::framework::OpKernelRegistrarFunctor<paddle::platform::CPUPlace, false, 0ul, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, float>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, double>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, int>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, long long> >::operator()(char const*, char const*) const::'lambda'(paddle::framework::ExecutionContext const&), std::__1::allocator<paddle::framework::OpKernelRegistrarFunctor<paddle::platform::CPUPlace, false, 0ul, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, float>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, double>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, int>, paddle::operators::ElementwiseSubKernel<paddle::platform::CPUDeviceContext, long long> >::operator()(char const*, char const*) const::'lambda'(paddle::framework::ExecutionContext const&)>, void (paddle::framework::ExecutionContext const&)>::operator()(paddle::framework::ExecutionContext const&) + 32
5          0x112bae223p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 659
6          0x112baa141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
7          0x111e533a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
8          0x111e52dd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
9          0x111db9837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
10         0x111d903aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
11         0x10502659fp PyCFunction_Call + 127
12         0x1050f17e7p PyEval_EvalFrameEx + 33207
13         0x1050e7fafp _PyEval_EvalCodeWithName + 335
14         0x1050ee2a7p PyEval_EvalFrameEx + 19575
15         0x1050e7fafp _PyEval_EvalCodeWithName + 335
16         0x1050ee2a7p PyEval_EvalFrameEx + 19575
17         0x1050e7fafp _PyEval_EvalCodeWithName + 335
18         0x10513a758p PyRun_FileExFlags + 248
19         0x105139eeep PyRun_SimpleFileExFlags + 382
20         0x10515ed86p Py_Main + 3622
21         0x104fa0861p main + 497
22      0x7fff763c5015p start + 1
```


+ 相关代码：

```python
if need_crop:
    conv = fluid.layers.crop(
        conv,
        shape=(-1, conv.shape[1], conv.shape[2] , conv.shape[3]),
        offsets=(0, 0, 1, 1))
if norm:
    conv = instance_norm(input=conv, name=name + "_norm")
if relu:
    conv = fluid.layers.leaky_relu(conv, alpha=relufactor)
return conv
```

+ 问题分析：

Enforce failed.强制执行失败，通常是使用Fluid方法时，参数传递错误。

+ 解决方法：

```python
if need_crop:
    conv = fluid.layers.crop(
        conv,
        shape=(-1, conv.shape[1], conv.shape[2] - 1, conv.shape[3] - 1),
        offsets=(0, 0, 1, 1))
if norm:
    conv = instance_norm(input=conv, name=name + "_norm")
if relu:
    conv = fluid.layers.leaky_relu(conv, alpha=relufactor)
return conv
```



## `待审核`9.问题：通过Fluid编写StarGAN，完全参考models中CycleGAN的代码，报错

+ 问题描述：通过Fluid编写StarGAN，完全参考models中CycleGAN的代码，报错

+ 报错输出：

```
-----------  Configuration Arguments -----------
batch_size: 1
epoch: 2
init_model: None
output: ./output_0
profile: False
run_ce: False
run_test: True
save_checkpoints: True
use_gpu: 0
------------------------------------------------
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 56, in train
    g_A_trainer = GATrainer(input_A, input_B)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/StarGAN/trainer.py", line 15, in __init__
    self.fake_B = build_generator_resnet_9blocks(input_A, name="g_A")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/StarGAN/model.py", line 18, in build_generator_resnet_9blocks
    o_c2 = conv2d(o_c1, 64, 3, 2, 0.02, "SAME", name + "_c2")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/StarGAN/layers.py", line 63, in conv2d
    filter_size)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/StarGAN/layers.py", line 13, in cal_padding
    if img_size % stride == 0:
TypeError: unsupported operand type(s) for %: 'Variable' and 'int'
```

+ 相关代码：

```
if padding == "SAME":
    top_padding, bottom_padding = cal_padding(input, stride,
                                              filter_size)
    left_padding, right_padding = cal_padding(input, stride,
                                              filter_size)
    height_padding = bottom_padding
    width_padding = right_padding
    if top_padding != bottom_padding or left_padding != right_padding:
        height_padding = top_padding + stride
        width_padding = left_padding + stride
        need_crop = True
else:
    height_padding = 0
    width_padding = 0
```

+ 问题分析：

从报错输出中以及可以定位具体的原因，`unsupported operand type(s) for %: 'Variable' and 'int'`表示不支持Variable与int这两种类型，该错误通常是传入了类型错误的变量导致，更加报错输出的内容定位，打印变量对应的类型则可。

+ 解决方法：

```
if padding == "SAME":
    top_padding, bottom_padding = cal_padding(input.shape[2], stride,
                                              filter_size)
    left_padding, right_padding = cal_padding(input.shape[2], stride,
                                              filter_size)
    height_padding = bottom_padding
    width_padding = right_padding
    if top_padding != bottom_padding or left_padding != right_padding:
        height_padding = top_padding + stride
        width_padding = left_padding + stride
        need_crop = True
else:
    height_padding = 0
    width_padding = 0
```


## `待审核`10.问题：D must match arity(DDim)

+ 问题描述：使用Paddle Fluid版实现GAN后，运行报错，`D must match arity(DDim)`

+ 报错输出：

```
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 164, in train
    "input_B": tensor_B})
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/executor.py", line 470, in run
    self.executor.run(program.desc, scope, 0, True, True)
paddle.fluid.core.EnforceNotMet: D must match arity(DDim) at [/Users/paddle/minqiyang/Paddle/paddle/fluid/framework/eigen.h:34]
PaddlePaddle Call Stacks:
0          0x114e97a68p paddle::platform::EnforceNotMet::EnforceNotMet(std::exception_ptr, char const*, int) + 760
1          0x1158dc1b8p paddle::framework::EigenDim<1>::From(paddle::framework::DDim const&) + 264
2          0x1158eebb5p paddle::framework::EigenTensor<float, 1ul, 1, long>::From(paddle::framework::Tensor const&) + 293
3          0x11584fce0p paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, float, paddle::operators::MeanGradFunctor>::Compute(paddle::framework::ExecutionContext const&) const + 720
4          0x11584f9d0p std::__1::__function::__func<paddle::framework::OpKernelRegistrarFunctor<paddle::platform::CPUPlace, false, 0ul, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, float, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, double, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, int, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, long long, paddle::operators::MeanGradFunctor> >::operator()(char const*, char const*) const::'lambda'(paddle::framework::ExecutionContext const&), std::__1::allocator<paddle::framework::OpKernelRegistrarFunctor<paddle::platform::CPUPlace, false, 0ul, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, float, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, double, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, int, paddle::operators::MeanGradFunctor>, paddle::operators::ReduceGradKernel<paddle::platform::CPUDeviceContext, long long, paddle::operators::MeanGradFunctor> >::operator()(char const*, char const*) const::'lambda'(paddle::framework::ExecutionContext const&)>, void (paddle::framework::ExecutionContext const&)>::operator()(paddle::framework::ExecutionContext const&) + 32
5          0x115cc0223p paddle::framework::OperatorWithKernel::RunImpl(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) const + 659
6          0x115cbc141p paddle::framework::OperatorBase::Run(paddle::framework::Scope const&, boost::variant<paddle::platform::CUDAPlace, paddle::platform::CPUPlace, paddle::platform::CUDAPinnedPlace, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_, boost::detail::variant::void_> const&) + 577
7          0x114f653a6p paddle::framework::Executor::RunPreparedContext(paddle::framework::ExecutorPrepareContext*, paddle::framework::Scope*, bool, bool, bool) + 390
8          0x114f64dd3p paddle::framework::Executor::Run(paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool) + 163
9          0x114ecb837p void pybind11::cpp_function::initialize<paddle::pybind::pybind11_init()::$_64, void, paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool, pybind11::name, pybind11::is_method, pybind11::sibling>(paddle::pybind::pybind11_init()::$_64&&, void (*)(paddle::framework::Executor&, paddle::framework::ProgramDesc const&, paddle::framework::Scope*, int, bool, bool), pybind11::name const&, pybind11::is_method const&, pybind11::sibling const&)::'lambda'(pybind11::detail::function_call&)::__invoke(pybind11::detail::function_call&) + 135
10         0x114ea23aap pybind11::cpp_function::dispatcher(_object*, _object*, _object*) + 5786
11         0x106fa559fp PyCFunction_Call + 127
12         0x1070707e7p PyEval_EvalFrameEx + 33207
13         0x107066fafp _PyEval_EvalCodeWithName + 335
14         0x10706d2a7p PyEval_EvalFrameEx + 19575
15         0x107066fafp _PyEval_EvalCodeWithName + 335
16         0x10706d2a7p PyEval_EvalFrameEx + 19575
17         0x107066fafp _PyEval_EvalCodeWithName + 335
18         0x1070b9758p PyRun_FileExFlags + 248
19         0x1070b8eeep PyRun_SimpleFileExFlags + 382
20         0x1070ddd86p Py_Main + 3622
21         0x106f1f861p main + 497
22      0x7fff763c5015p start + 1
```

+ 相关代码：

```
helper = fluid.layer_helper.LayerHelper("instance_norm", **locals())
dtype = helper.input_dtype()
epsilon = 1e-5
mean = fluid.layers.reduce_mean(input, keep_dim=True)
var = fluid.layers.reduce_mean(
    fluid.layers.square(input - mean), keep_dim=True)
if name is not None:
    scale_name = name + "_scale"
    offset_name = name + "_offset"
scale_param = fluid.ParamAttr(
    name=scale_name,
    initializer=fluid.initializer.TruncatedNormal(1.0, 0.02),
    trainable=True)
```


+ 问题分析：

`paddle.fluid.core.EnforceNotMet: D must match arity(DDim)`错误，通常有Fluid中某些方法没有传入错误的类型，从相关代码中可以看出reduce_mean()方法没有传递dim参数

+ 解决方法：


```
helper = fluid.layer_helper.LayerHelper("instance_norm", **locals())
dtype = helper.input_dtype()
epsilon = 1e-5
mean = fluid.layers.reduce_mean(input, dim=[2, 3], keep_dim=True)
var = fluid.layers.reduce_mean(
    fluid.layers.square(input - mean), dim=[2, 3], keep_dim=True)
if name is not None:
    scale_name = name + "_scale"
    offset_name = name + "_offset"
scale_param = fluid.ParamAttr(
    name=scale_name,
    initializer=fluid.initializer.TruncatedNormal(1.0, 0.02),
    trainable=True)
```

## `待审核`11.问题：create_parameter() missing 1 required positional argument: 'dtype'

+ 问题描述：使用简单的GAN，报create_parameter() missing 1 required positional argument: 'dtype'

+ 报错输出：

```
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 56, in train
    g_A_trainer = GATrainer(input_A, input_B)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/trainer.py", line 15, in __init__
    self.fake_B = build_generator_resnet_9blocks(input_A, name="g_A")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/model.py", line 17, in build_generator_resnet_9blocks
    o_c1 = conv2d(pad_input, 32, 7, 1, 0.02, name=name + "_c1")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/layers.py", line 98, in conv2d
    conv = instance_norm(input=conv, name=name + "_norm")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/layers.py", line 39, in instance_norm
    attr=scale_param, shape=input.shape[1:2],)
TypeError: create_parameter() missing 1 required positional argument: 'dtype'
```

+ 相关代码：

```
scale = helper.create_parameter(
    attr=scale_param, shape=input.shape[1:2],)
offset = helper.create_parameter(
    attr=offset_param, shape=input.shape[1:2],)

tmp = fluid.layers.elementwise_mul(x=(input - mean), y=scale, axis=1)
tmp = tmp / fluid.layers.sqrt(var + epsilon)
tmp = fluid.layers.elementwise_add(tmp, offset, axis=1)
```

+ 问题分析：

create_parameter()添加上dtype参数则可。

+ 解决方法：

使用helper.input_dtype()来定义dtype，添加，如下：

```
helper = fluid.layer_helper.LayerHelper("instance_norm", **locals())
dtype = helper.input_dtype()
scale = helper.create_parameter(
        attr=scale_param, shape=input.shape[1:2], dtype=dtype)
offset = helper.create_parameter(
        attr=offset_param, shape=input.shape[1:2], dtype=dtype)
```

直接定义一个dtype，传入

```
scale = helper.create_parameter(
        attr=scale_param, shape=input.shape[1:2],dtype='float32')
offset = helper.create_parameter(
        attr=offset_param, shape=input.shape[1:2],dtype='float32')
```

## `待审核`12.问题：Parameter shape should not be related with batch-size

+ 问题描述：Fuild实现运行GAN，报错`Parameter shape should not be related with batch-size`

+ 报错输出：

```
-----------  Configuration Arguments -----------
batch_size: 1
epoch: 2
init_model: None
output: ./output_0
profile: False
run_ce: False
run_test: True
save_checkpoints: True
use_gpu: 0
------------------------------------------------
Traceback (most recent call last):
  File "train.py", line 222, in <module>
    train(args)
  File "train.py", line 56, in train
    g_A_trainer = GATrainer(input_A, input_B)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/trainer.py", line 15, in __init__
    self.fake_B = build_generator_resnet_9blocks(input_A, name="g_A")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/model.py", line 17, in build_generator_resnet_9blocks
    o_c1 = conv2d(pad_input, 32, 7, 1, 0.02, name=name + "_c1")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/layers.py", line 98, in conv2d
    conv = instance_norm(input=conv, name=name + "_norm")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/cycle_gan/layers.py", line 39, in instance_norm
    attr=scale_param, shape=input.shape, dtype=dtype)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/layer_helper.py", line 317, in create_parameter
    dtype=dtype, shape=shape, **attr._to_kwargs(with_initializer=True))
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/framework.py", line 1175, in create_parameter
    param = Parameter(global_block, *args, **kwargs)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/framework.py", line 2009, in __init__
    raise ValueError("Parameter shape should not be related with "
ValueError: Parameter shape should not be related with batch-size
```

+ 相关代码：

```
scale = helper.create_parameter(
        attr=scale_param, shape=input.shape, dtype=dtype)
offset = helper.create_parameter(
        attr=offset_param, shape=input.shape, dtype=dtype)
```

+ 问题分析：

`Parameter shape should not be related with batch-size`错误通常是方法传参时，参数shape错误了

+ 解决方法：

```
scale = helper.create_parameter(
        attr=scale_param, shape=input.shape[1:2], dtype=dtype)
offset = helper.create_parameter(
        attr=offset_param, shape=input.shape[1:2], dtype=dtype)
```


## `待审核`13.问题：missing 1 required positional argument: 'value'

+ 问题描述：Fluid实现简单GAN，报missing 1 required positional argument: 'value'

+ 报错输出：

```
-----------  Configuration Arguments -----------
batch_size: 121
epoch: 20
output: ./output
run_ce: False
use_gpu: 0
------------------------------------------------
Traceback (most recent call last):
  File "c_gan.py", line 204, in <module>
    train(args)
  File "c_gan.py", line 69, in train
    d_logit = D_cond(img, conditions)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/c_gan/network.py", line 98, in D_cond
    x = conv_cond_concat(image, yb)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/c_gan/network.py", line 91, in conv_cond_concat
    x, [-1, y.shape[1], x.shape[2], x.shape[3]], 1.0)
TypeError: fill_constant_batch_size_like() missing 1 required positional argument: 'value'
```

+ 相关代码：

```
def conv_cond_concat(x, y):
    ones = fluid.layers.fill_constant_batch_size_like(
        x, [-1, y.shape[1], x.shape[2], x.shape[3]], 1.0)
    return fluid.layers.concat([x, ones * y], 1)
```

+ 问题分析：

从报错输出与相关代码来看，给fill_constant_batch_size_like()方法添加value参数则可，values参数通常用于表示value相应的类型

+ 解决方法：

```
def conv_cond_concat(x, y):
    """Concatenate conditioning vector on feature map axis."""
    ones = fluid.layers.fill_constant_batch_size_like(
        x, [-1, y.shape[1], x.shape[2], x.shape[3]], "float32", 1.0)
    return fluid.layers.concat([x, ones * y], 1)
```


## `待审核`14.问题：'NoneType' object has no attribute 'shape'

+ 问题描述：Fluid实现GAN后，运行报错

+ 报错输出：

```
Traceback (most recent call last):
  File "c_gan.py", line 204, in <module>
    train(args)
  File "c_gan.py", line 69, in train
    d_logit = D_cond(img, conditions)
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/c_gan/network.py", line 103, in D_cond
    h1 = bn(conv(h0, df_dim + y_dim), act="leaky_relu")
  File "/Users/ayuliao/Desktop/Paddle/models/fluid/PaddleCV/gan/c_gan/network.py", line 50, in conv
    act=act)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/nets.py", line 122, in simple_img_conv_pool
    use_cudnn=use_cudnn)
  File "/Users/ayuliao/anaconda3/envs/paddle/lib/python3.5/site-packages/paddle/fluid/layers/nn.py", line 1593, in conv2d
    num_channels = input.shape[1]
AttributeError: 'NoneType' object has no attribute 'shape'
```

+ 问题分析：

`'NoneType' object has no attribute 'shape'`表示传入的参数是没有形状的，关注错误栈中的报错信息，打印每个变量的形状来判断不同变量的形状。

+ 解决方法：

```
image = fluid.layers.reshape(x=image, shape=[-1, 1, 28, 28])
yb = fluid.layers.reshape(y, [-1, y_dim, 1, 1])
x = conv_cond_concat(image, yb)

h0 = conv(x, c_dim + y_dim, act="leaky_relu")
h0 = conv_cond_concat(h0, yb)
h1 = bn(conv(h0, df_dim + y_dim), act="leaky_relu")
h1 = fluid.layers.flatten(h1, axis=1)
```



## `待审核`15.问题：如何在训练GAN时自定义不同的学习速率

+ 问题描述：如何在训练GAN时自定义不同的学习速率

+ 问题分析：

适当的学习速率有助于训练，Fluid提供了自由度很高的优化方法，这里以Adam()方法为例，代码如下。

+ 解决方法：

```
vars = []
for var in self.program.list_vars():
    if fluid.io.is_parameter(var) and var.name.startswith("g_A"):
        vars.append(var.name)
self.param = vars
lr = 0.0002
optimizer = fluid.optimizer.Adam(
    learning_rate=fluid.layers.piecewise_decay(
        boundaries=[
            100 * step_per_epoch, 120 * step_per_epoch,
            140 * step_per_epoch, 160 * step_per_epoch,
            180 * step_per_epoch
        ],
        values=[
            lr, lr * 0.8, lr * 0.6, lr * 0.4, lr * 0.2, lr * 0.1
        ]),
    beta1=0.5,
    name="g_A")
optimizer.minimize(self.g_loss_A, parameter_list=vars)
```












